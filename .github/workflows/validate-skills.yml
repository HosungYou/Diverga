name: Validate SKILL.md Files

on:
  push:
    branches: [main]
    paths:
      - 'skills/**/SKILL.md'
      - '.github/workflows/validate-skills.yml'
  pull_request:
    branches: [main]
    paths:
      - 'skills/**/SKILL.md'
      - '.github/workflows/validate-skills.yml'

jobs:
  validate-skill-format:
    name: Validate SKILL.md Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate SKILL.md files
        run: |
          python3 << 'EOF'
          import os
          import sys
          import yaml
          import re

          SKILLS_DIR = "skills"
          REQUIRED_FIELDS = ["name", "description", "version"]
          errors = []
          warnings = []
          validated = 0

          def extract_frontmatter(content):
              """Extract YAML frontmatter from markdown file."""
              match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
              if match:
                  return match.group(1)
              return None

          def validate_skill(filepath):
              """Validate a single SKILL.md file."""
              global errors, warnings, validated

              with open(filepath, 'r', encoding='utf-8') as f:
                  content = f.read()

              # Extract frontmatter
              frontmatter = extract_frontmatter(content)
              if not frontmatter:
                  errors.append(f"{filepath}: Missing YAML frontmatter (---))")
                  return False

              # Parse YAML
              try:
                  data = yaml.safe_load(frontmatter)
              except yaml.YAMLError as e:
                  errors.append(f"{filepath}: Invalid YAML: {e}")
                  return False

              if not isinstance(data, dict):
                  errors.append(f"{filepath}: Frontmatter is not a valid YAML dictionary")
                  return False

              # Check required fields
              for field in REQUIRED_FIELDS:
                  if field not in data:
                      errors.append(f"{filepath}: Missing required field '{field}'")
                  elif not data[field]:
                      errors.append(f"{filepath}: Field '{field}' is empty")

              # Validate version format
              if "version" in data:
                  version = str(data["version"])
                  if not re.match(r'^\d+\.\d+\.\d+$', version):
                      warnings.append(f"{filepath}: Version '{version}' doesn't follow semver format (x.y.z)")

              # Validate name matches directory
              if "name" in data:
                  dir_name = os.path.basename(os.path.dirname(filepath))
                  skill_name = data["name"]
                  if skill_name != dir_name:
                      warnings.append(f"{filepath}: Skill name '{skill_name}' doesn't match directory '{dir_name}'")

              # Check for unsupported fields
              SUPPORTED_FIELDS = ["name", "description", "version"]
              for field in data.keys():
                  if field not in SUPPORTED_FIELDS:
                      warnings.append(f"{filepath}: Unsupported field '{field}' may break Claude Code parsing")

              validated += 1
              return len([e for e in errors if filepath in e]) == 0

          # Find and validate all SKILL.md files
          print("=" * 60)
          print("SKILL.md Validation Report")
          print("=" * 60)
          print()

          skill_files = []
          for root, dirs, files in os.walk(SKILLS_DIR):
              for f in files:
                  if f == "SKILL.md":
                      skill_files.append(os.path.join(root, f))

          print(f"Found {len(skill_files)} SKILL.md files")
          print()

          for filepath in sorted(skill_files):
              validate_skill(filepath)

          # Print results
          if errors:
              print("ERRORS:")
              for e in errors:
                  print(f"  ❌ {e}")
              print()

          if warnings:
              print("WARNINGS:")
              for w in warnings:
                  print(f"  ⚠️  {w}")
              print()

          print("=" * 60)
          print(f"Validated: {validated}/{len(skill_files)} files")
          print(f"Errors: {len(errors)}")
          print(f"Warnings: {len(warnings)}")
          print("=" * 60)

          # Exit with error if any required fields are missing
          if errors:
              print()
              print("❌ Validation FAILED")
              print()
              print("Required fields for Claude Code skill discovery:")
              print("  - name: skill identifier (should match directory name)")
              print("  - description: skill description (multiline supported)")
              print("  - version: semver version string (e.g., '6.9.1')")
              sys.exit(1)
          else:
              print()
              print("✅ All SKILL.md files are valid!")
              sys.exit(0)
          EOF

      - name: Count skills
        run: |
          echo "Skills directory structure:"
          ls -la skills/ | head -20
          echo ""
          echo "Total skill directories: $(ls -d skills/*/ 2>/dev/null | wc -l)"

  check-skill-count:
    name: Verify Skill Count
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify expected skill count
        run: |
          EXPECTED_COUNT=51
          ACTUAL_COUNT=$(find skills -name "SKILL.md" | wc -l | tr -d ' ')

          echo "Expected skills: $EXPECTED_COUNT"
          echo "Actual skills: $ACTUAL_COUNT"

          if [ "$ACTUAL_COUNT" -lt "$EXPECTED_COUNT" ]; then
            echo "❌ Missing skills! Expected $EXPECTED_COUNT, found $ACTUAL_COUNT"
            exit 1
          else
            echo "✅ Skill count verified: $ACTUAL_COUNT"
          fi

  check-version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          echo "Checking version consistency across SKILL.md files..."

          # Extract versions from all SKILL.md files
          versions=$(grep -h "^version:" skills/*/SKILL.md 2>/dev/null | sort | uniq -c | sort -rn)

          echo ""
          echo "Version distribution:"
          echo "$versions"
          echo ""

          # Check if all versions are the same
          version_count=$(echo "$versions" | wc -l | tr -d ' ')
          if [ "$version_count" -gt 1 ]; then
            echo "⚠️  Warning: Multiple versions found in SKILL.md files"
            echo "Consider standardizing all skills to the same version"
          else
            echo "✅ All SKILL.md files have consistent versions"
          fi
